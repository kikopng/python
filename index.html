<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini AI Chatbot</title>
    <!-- Load Tailwind CSS for beautiful, responsive styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom scrollbar styling for the chat window */
        #chat-window {
            height: 70vh;
            overflow-y: auto;
            scroll-behavior: smooth;
        }
        /* Style for the user and assistant messages */
        .user-message {
            @apply bg-indigo-500 text-white p-3 rounded-lg max-w-lg self-end;
        }
        .assistant-message {
            @apply bg-gray-200 text-gray-800 p-3 rounded-lg max-w-lg self-start;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen font-sans">

    <div class="container mx-auto p-4 flex flex-col h-screen">
        <header class="text-center py-4">
            <h1 class="text-4xl font-extrabold text-indigo-700">ðŸ¤– Gemini Chat</h1>
            <p class="text-gray-500 mt-1">Ask me anything!</p>
        </header>

        <!-- Chat Display Area -->
        <div id="chat-window" class="flex flex-col space-y-4 p-4 mb-4 bg-white shadow-xl rounded-xl ring-1 ring-gray-200">
            <!-- Initial welcome message from the assistant -->
            <div class="assistant-message">
                Hello! I'm an AI powered by Gemini. How can I help you today?
            </div>
        </div>

        <!-- Input Area -->
        <div class="mt-auto bg-white p-4 rounded-xl shadow-2xl sticky bottom-0">
            <div class="flex items-center space-x-3">
                <input
                    type="text"
                    id="user-input"
                    placeholder="Type your message..."
                    class="flex-grow p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition duration-150"
                    onkeydown="if(event.key === 'Enter') sendMessage()"
                />
                <button
                    id="send-button"
                    onclick="sendMessage()"
                    class="bg-indigo-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-indigo-700 transition duration-150 shadow-md disabled:bg-indigo-300"
                >
                    Send
                </button>
            </div>
        </div>

        <!-- Loading Indicator -->
        <div id="loading-indicator" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white p-5 rounded-lg shadow-xl flex items-center space-x-3">
                <svg class="animate-spin h-5 w-5 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span class="text-gray-700">AI is thinking...</span>
            </div>
        </div>
    </div>

    <script>
        const chatWindow = document.getElementById('chat-window');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const loadingIndicator = document.getElementById('loading-indicator');

        // Helper function for exponential backoff during API calls
        async function fetchWithRetry(url, options, retries = 3) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) {
                        // If the response is not successful, try again
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response;
                } catch (error) {
                    if (i < retries - 1) {
                        // Calculate exponential delay with jitter
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    } else {
                        // Re-throw the error on the last attempt
                        throw error;
                    }
                }
            }
        }

        function createMessageElement(text, isUser) {
            const container = document.createElement('div');
            container.classList.add('flex', isUser ? 'justify-end' : 'justify-start');

            const messageDiv = document.createElement('div');
            messageDiv.innerHTML = text.replace(/\n/g, '<br>'); // Preserve line breaks
            messageDiv.classList.add(isUser ? 'user-message' : 'assistant-message');
            
            container.appendChild(messageDiv);
            chatWindow.appendChild(container);
            
            // Scroll to the bottom to see the new message
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        async function sendMessage() {
            const query = userInput.value.trim();
            if (!query) return;

            // 1. Display user message and clear input
            createMessageElement(query, true);
            userInput.value = '';
            userInput.disabled = true;
            sendButton.disabled = true;
            loadingIndicator.classList.remove('hidden');

            const apiKey = ""; // API key is provided by the environment
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: query }] }],
                // We use Google Search grounding for real-time, grounded answers
                tools: [{ "google_search": {} }],
            };

            const options = {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            };

            try {
                // 2. Call the Gemini API using the retry helper
                const response = await fetchWithRetry(apiUrl, options);
                const result = await response.json();

                let assistantResponse = "Sorry, I encountered an issue. Please try again.";

                const candidate = result.candidates?.[0];
                if (candidate && candidate.content?.parts?.[0]?.text) {
                    assistantResponse = candidate.content.parts[0].text;
                }
                
                // 3. Display assistant's response
                createMessageElement(assistantResponse, false);

            } catch (error) {
                console.error('Error during API call:', error);
                createMessageElement("Error: Could not connect to the AI. Check the console for details.", false);
            } finally {
                // 4. Reset UI state
                userInput.disabled = false;
                sendButton.disabled = false;
                loadingIndicator.classList.add('hidden');
                userInput.focus(); // Focus the input for the next message
            }
        }
    </script>
</body>
</html>
