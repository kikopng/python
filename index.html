import React, { useState, useEffect, useRef } from 'react';
import { Heart, Play, Sparkles, Music, ChevronDown, Star } from 'lucide-react';

export default function App() {
  const [stage, setStage] = useState('landing'); // landing, journey, finale
  const [particles, setParticles] = useState([]);
  const [loveScore, setLoveScore] = useState(0);
  const [showVideo, setShowVideo] = useState(false);
  
  const audioRef = useRef(null);

  // Configuration - Edit your photo details here!
  const memories = [
    { id: 1, url: 'assets/photo1.jpg', caption: 'The night it all began.', detail: 'I still remember exactly what you were wearing.' },
    { id: 2, url: 'assets/photo2.jpg', caption: 'Our favorite adventure.', detail: 'The world is better with you by my side.' },
    { id: 3, url: 'assets/photo3.jpg', caption: 'I love your laugh.', detail: 'It is my favorite sound in the whole world.' },
    { id: 4, url: 'assets/photo4.jpg', caption: 'Simply us.', detail: 'Forever isn\'t long enough.' },
  ];

  // Logic for the "Heartburst" effect
  const createHeartBurst = (e) => {
    const isTouchEvent = e.type === 'touchstart';
    const clientX = isTouchEvent ? e.touches[0].clientX : e.clientX;
    const clientY = isTouchEvent ? e.touches[0].clientY : e.clientY;

    const newParticles = Array.from({ length: 8 }).map(() => ({
      id: Math.random(),
      x: clientX,
      y: clientY,
      size: Math.random() * 20 + 10,
      angle: Math.random() * Math.PI * 2,
      velocity: Math.random() * 3 + 2,
      color: ['#f43f5e', '#fb7185', '#fff1f2', '#fbbf24'][Math.floor(Math.random() * 4)],
      type: Math.random() > 0.5 ? 'heart' : 'sparkle'
    }));

    setParticles(prev => [...prev, ...newParticles]);
    setLoveScore(prev => Math.min(prev + 2, 100));

    // Cleanup particles
    setTimeout(() => {
      setParticles(prev => prev.filter(p => !newParticles.includes(p)));
    }, 1000);
  };

  const startJourney = () => {
    setStage('journey');
    if (audioRef.current) {
      audioRef.current.volume = 0.4;
      audioRef.current.play().catch(e => console.log("Audio play blocked."));
    }
  };

  return (
    <div 
      className="min-h-screen bg-[#0f0506] text-white font-sans selection:bg-rose-500 overflow-x-hidden cursor-crosshair"
      onMouseDown={stage === 'journey' ? createHeartBurst : undefined}
      onTouchStart={stage === 'journey' ? createHeartBurst : undefined}
    >
      {/* Visual Effects Layer */}
      {particles.map(p => (
        <div
          key={p.id}
          className="fixed pointer-events-none z-[60] animate-out fade-out zoom-out duration-1000"
          style={{
            left: p.x,
            top: p.y,
            transform: `translate(-50%, -50%)`,
            '--tw-translate-x': `${Math.cos(p.angle) * p.velocity * 50}px`,
            '--tw-translate-y': `${Math.sin(p.angle) * p.velocity * 50}px`,
          } as any}
        >
          {p.type === 'heart' ? (
            <Heart size={p.size} fill={p.color} className="text-transparent transform translate-x-[var(--tw-translate-x)] translate-y-[var(--tw-translate-y)]" />
          ) : (
            <Sparkles size={p.size} className="text-yellow-400 transform translate-x-[var(--tw-translate-x)] translate-y-[var(--tw-translate-y)]" />
          )}
        </div>
      ))}

      {/* Persistent Background Hearts */}
      <div className="fixed inset-0 pointer-events-none opacity-10 z-0">
        {[...Array(12)].map((_, i) => (
          <div 
            key={i}
            className="absolute animate-pulse text-rose-600"
            style={{
              top: `${Math.random() * 100}%`,
              left: `${Math.random() * 100}%`,
              animationDelay: `${Math.random() * 5}s`,
              fontSize: `${Math.random() * 20 + 10}px`
            }}
          >
            ‚ù§
          </div>
        ))}
      </div>

      <audio ref={audioRef} src="assets/song.mp3" loop />

      {/* Stage 1: The Landing */}
      {stage === 'landing' && (
        <div className="h-screen flex flex-col items-center justify-center p-6 text-center relative">
          <div className="absolute inset-0 bg-radial-gradient from-rose-900/20 to-transparent"></div>
          <div className="relative group cursor-pointer" onClick={startJourney}>
            <div className="absolute inset-0 bg-rose-600 blur-[80px] opacity-20 group-hover:opacity-50 transition-all duration-1000 animate-pulse"></div>
            <Heart size={100} className="text-rose-600 animate-bounce relative z-10 fill-current hover:scale-110 transition-transform duration-500" />
            <div className="mt-12 space-y-4 relative z-10">
              <h1 className="text-4xl font-serif italic text-rose-100 tracking-widest">For My Everything</h1>
              <p className="text-rose-200/60 uppercase text-[10px] tracking-[0.4em] animate-pulse">Tap the heart to enter</p>
            </div>
          </div>
        </div>
      )}

      {/* Stage 2: The Journey */}
      {stage === 'journey' && (
        <div className="animate-in fade-in duration-1000">
          {/* Progress Bar (Love Meter) */}
          <div className="fixed top-0 left-0 w-full h-1 z-50 bg-white/5">
            <div 
              className="h-full bg-gradient-to-r from-rose-900 via-rose-500 to-rose-400 shadow-[0_0_10px_#f43f5e] transition-all duration-500"
              style={{ width: `${loveScore}%` }}
            />
          </div>

          <div className="max-w-2xl mx-auto px-6 py-20 relative z-10">
            <div className="text-center mb-40">
              <h1 className="text-6xl font-serif italic mb-6 text-rose-100">Our Memories</h1>
              <div className="h-px w-32 bg-gradient-to-r from-transparent via-rose-800 to-transparent mx-auto"></div>
              <p className="mt-8 text-rose-300/40 italic text-sm">Tap anywhere to spread the love</p>
              <div className="mt-10 animate-bounce text-rose-900">
                <ChevronDown className="mx-auto" />
              </div>
            </div>

            <div className="space-y-64">
              {memories.map((m) => (
                <div key={m.id} className="relative group">
                  <div className="absolute -left-6 top-0 bottom-0 w-[1px] bg-gradient-to-b from-rose-600/50 via-rose-900/10 to-transparent"></div>
                  <div className="pl-10">
                    <div className="relative rounded-2xl overflow-hidden shadow-[0_30px_60px_rgba(0,0,0,0.8)] border border-white/5 group-hover:border-rose-500/50 transition-all duration-1000 bg-zinc-900">
                      <img 
                        src={m.url} 
                        alt={m.caption} 
                        className="w-full grayscale opacity-50 group-hover:grayscale-0 group-hover:opacity-100 transition-all duration-1000 scale-110 group-hover:scale-100" 
                      />
                      {/* Surprise trigger on photo */}
                      <button 
                        onClick={(e) => { e.stopPropagation(); createHeartBurst(e); }}
                        className="absolute bottom-4 right-4 p-3 bg-white/10 backdrop-blur-md rounded-full text-rose-400 opacity-0 group-hover:opacity-100 transition-opacity"
                      >
                        <Star size={20} className="animate-spin-slow" />
                      </button>
                    </div>
                    <div className="mt-8 transform transition-transform group-hover:translate-x-2 duration-500">
                        <span className="text-rose-600 font-serif italic text-sm">#{m.id}</span>
                        <h2 className="text-3xl font-serif text-rose-50 mt-2">{m.caption}</h2>
                        <p className="text-rose-200/40 mt-3 font-light leading-relaxed">{m.detail}</p>
                    </div>
                  </div>
                </div>
              ))}
            </div>

            {/* Hint for the finale */}
            <div className="mt-60 text-center pb-60">
                <p className="text-rose-500/40 uppercase text-[9px] tracking-[0.5em] mb-12">Click to reveal the final gift</p>
                <div className="inline-block p-[1px] rounded-full bg-gradient-to-r from-rose-900 via-rose-500 to-rose-900 shadow-[0_0_30px_rgba(225,29,72,0.2)]">
                    <button 
                        onClick={() => { setStage('finale'); setShowVideo(true); }}
                        className="flex items-center gap-6 px-12 py-6 bg-[#0f0506] rounded-full hover:bg-rose-600 transition-all duration-700 group overflow-hidden relative"
                    >
                        <div className="absolute inset-0 bg-white/5 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                        <Play size={20} className="text-rose-500 group-hover:text-white fill-current relative z-10" />
                        <span className="font-semibold tracking-widest uppercase text-xs group-hover:text-white relative z-10">Play Our Story</span>
                    </button>
                </div>
            </div>
          </div>
        </div>
      )}

      {/* Stage 3: Finale */}
      {stage === 'finale' && (
        <div className="fixed inset-0 bg-black z-[100] flex flex-col items-center justify-center p-4 animate-in fade-in zoom-in duration-1000">
          <div className="w-full max-w-5xl aspect-video rounded-3xl overflow-hidden shadow-[0_0_100px_rgba(225,29,72,0.4)] border border-white/5 relative bg-zinc-950">
            {showVideo && (
              <video 
                src="assets/video.mp4" 
                controls 
                autoPlay 
                className="w-full h-full object-contain"
                onPlay={() => { if(audioRef.current) audioRef.current.pause(); }}
              />
            )}
          </div>
          <div className="mt-12 text-center">
            <h2 className="text-rose-50 font-serif italic text-3xl mb-3">I Love You</h2>
            <p className="text-rose-400/30 text-xs tracking-widest uppercase mb-10">Forever & Always</p>
            <button 
                onClick={() => { setStage('journey'); if(audioRef.current) audioRef.current.play(); }}
                className="group flex items-center gap-2 mx-auto text-rose-900 hover:text-rose-500 transition-all text-[10px] uppercase tracking-[0.2em]"
            >
                <ChevronDown className="rotate-90 group-hover:-translate-x-1 transition-transform" size={12} />
                <span>Return to Journey</span>
            </button>
          </div>
        </div>
      )}

      <style>{`
        @keyframes spin-slow {
          from { transform: rotate(0deg); }
          to { transform: rotate(360deg); }
        }
        .animate-spin-slow {
          animation: spin-slow 12s linear infinite;
        }
        .bg-radial-gradient {
          background: radial-gradient(circle, var(--tw-gradient-from), var(--tw-gradient-to));
        }
      `}</style>
    </div>
  );
}
