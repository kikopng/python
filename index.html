<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Skyworld Loots - Arcade Theme (Polished)</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    /* Base */
    :root{
      --bg:#071028;
      --card:#0f1724;
      --muted:#94a3b8;
      --accent1:#7c3aed; /* purple */
      --accent2:#06b6d4; /* cyan */
      --accent3:#fb7185; /* pink */
      --neon:#f97316; /* orange */
    }
    html,body{height:100%;margin:0;padding:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;}
    body{
      background:
        radial-gradient(1200px 600px at 10% 10%, rgba(124,58,237,0.08), transparent 8%),
        radial-gradient(800px 500px at 90% 85%, rgba(6,182,212,0.06), transparent 6%),
        var(--bg);
      color:#e6eef8;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      line-height:1.4;
    }

    /* Layout */
    .main-container{min-height:100vh;display:flex;flex-direction:column;}
    header.site-header{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:10px;
      padding:1.5rem;
      background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.0));
      border-bottom:1px solid rgba(255,255,255,0.03);
      position:relative;
      z-index:30;
      backdrop-filter: blur(4px);
    }

    /* Glowing title */
    .site-title{
      font-size:2.2rem;
      font-weight:800;
      letter-spacing:0.08em;
      color:var(--neon);
      text-transform:uppercase;
      text-shadow:
        0 0 6px rgba(249,115,22,0.9),
        0 0 18px rgba(249,115,22,0.35),
        0 6px 30px rgba(0,0,0,0.55);
      display:flex;
      gap:12px;
      align-items:center;
    }
    .title-badge{
      background:linear-gradient(90deg,var(--accent1),var(--accent2));
      padding:6px 10px;
      border-radius:999px;
      font-weight:700;
      color:white;
      font-size:0.8rem;
      box-shadow:0 4px 18px rgba(124,58,237,0.18);
    }
    .header-actions{display:flex;gap:0.5rem;flex-wrap:wrap;justify-content:center;}

    /* Content grid */
    .content-grid{
      display:grid;
      grid-template-columns:1fr;
      gap:1.25rem;
      padding:1.25rem;
      width:100%;
      box-sizing:border-box;
    }
    @media(min-width:1024px){
      .content-grid{grid-template-columns: 1.4fr 1fr; padding:2rem 3rem; gap:1.5rem; align-items:start;}
    }

    /* Cards */
    .arcade-card{
      background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-radius:12px;
      padding:1.25rem;
      border:1px solid rgba(255,255,255,0.03);
      box-shadow: 0 8px 30px rgba(2,6,23,0.6), inset 0 1px 0 rgba(255,255,255,0.02);
    }

    /* Schedule timeline */
    .timeline{display:flex;flex-direction:column;gap:0.75rem;}
    .schedule-item{
      display:flex;gap:1rem;align-items:flex-start;padding:0.9rem;border-radius:10px;
      transition:all .18s ease;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));
      border:1px solid rgba(124,58,237,0.06);
      cursor:pointer;
    }
    .schedule-item:hover{transform:translateY(-4px);box-shadow:0 10px 30px rgba(2,6,23,0.6);}
    .schedule-time{
      min-width:86px;color:var(--accent2);font-weight:700;text-shadow:0 0 6px rgba(6,182,212,0.12);
      font-family:Inter,system-ui; font-size:0.95rem;
    }
    .schedule-event{flex:1;color:var(--muted);}
    .schedule-event .title{color:var(--neon);font-weight:700;margin-bottom:4px;}
    .schedule-details{margin-top:8px;color:#9fb0c8;font-size:0.9rem;display:none;}
    .schedule-item.expanded .schedule-details{display:block;}
    .label-pill{display:inline-block;padding:4px 8px;border-radius:999px;background:linear-gradient(90deg,var(--accent1),var(--accent3));font-size:0.72rem;font-weight:700;color:white;margin-left:8px;box-shadow:0 6px 18px rgba(124,58,237,0.14);}

    /* Chat card and chat UI */
    .chat-card{display:flex;flex-direction:column;height:560px;max-height:78vh;}
    @media(max-width:640px){ .chat-card{height:68vh;}}
    .chat-header{display:flex;align-items:center;gap:10px;padding-bottom:0.5rem;border-bottom:1px solid rgba(255,255,255,0.03);margin-bottom:0.5rem;}
    .bot-avatar,.user-avatar{
      min-width:42px;min-height:42px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:800;color:white;
      box-shadow:0 6px 18px rgba(0,0,0,0.6);
    }
    .bot-avatar{background:linear-gradient(90deg,var(--accent2),var(--accent1));}
    .user-avatar{background:linear-gradient(90deg,var(--accent3),#fb923c);}
    .chat-area{flex:1;overflow:auto;padding:0.9rem;display:flex;flex-direction:column;gap:0.75rem;}
    .msg-row{display:flex;gap:10px;align-items:flex-end;}
    .msg-row.bot{justify-content:flex-start;}
    .msg-row.user{justify-content:flex-end;flex-direction:row-reverse;}
    .bubble{
      max-width:72%;padding:10px 12px;border-radius:12px;position:relative;line-height:1.25;font-size:0.92rem;box-shadow:0 6px 20px rgba(2,6,23,0.6);
      white-space:pre-wrap;
    }
    .bubble.bot{
      background:linear-gradient(180deg, rgba(255,255,255,0.95), rgba(255,255,255,0.95));
      color:#0b1220;border-radius:12px;border:1px solid rgba(6,182,212,0.06);
    }
    .bubble.user{
      background:linear-gradient(90deg,var(--accent3),#fb7185);color:white;border-radius:12px;border:1px solid rgba(255,255,255,0.03);
    }

    /* tails */
    .bubble.bot::after{
      content:"";position:absolute;left:-8px;bottom:8px;width:14px;height:14px;background:linear-gradient(180deg, rgba(255,255,255,0.95), rgba(255,255,255,0.95));transform:rotate(45deg);box-shadow:inherit;border-left:1px solid rgba(6,182,212,0.03);
    }
    .bubble.user::after{
      content:"";position:absolute;right:-8px;bottom:8px;width:14px;height:14px;background:linear-gradient(90deg,var(--accent3),#fb7185);transform:rotate(45deg);
    }

    /* typing animation */
    .typing{
      display:inline-flex;gap:6px;padding:6px 8px;border-radius:10px;background:rgba(255,255,255,0.06);
    }
    .typing .dot{width:7px;height:7px;border-radius:999px;background:rgba(255,255,255,0.5);animation:blink 1s infinite;}
    .typing .dot:nth-child(2){animation-delay:0.15s}
    .typing .dot:nth-child(3){animation-delay:0.3s}
    @keyframes blink{0%{opacity:.25;transform:translateY(0)}50%{opacity:1;transform:translateY(-4px)}100%{opacity:.25;transform:translateY(0)}}

    /* input area */
    .chat-input-area{display:flex;gap:0.5rem;padding:0.9rem;border-top:1px solid rgba(255,255,255,0.03);background:linear-gradient(180deg, rgba(0,0,0,0.2), transparent);}
    .chat-input{flex:1;background:#061124;border-radius:10px;padding:10px 12px;border:1px solid rgba(255,255,255,0.03);color:#dbe9fb;outline:none;}
    .chat-input:focus{box-shadow:0 0 0 4px rgba(6,182,212,0.08);border:1px solid rgba(6,182,212,0.18);}

    .btn{
      display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border-radius:10px;border:none;font-weight:700;cursor:pointer;
      background:linear-gradient(90deg,var(--accent1),var(--accent2));color:white;box-shadow:0 8px 24px rgba(7,12,30,0.6);
    }
    .btn.secondary{background:linear-gradient(90deg,var(--accent3),#fb923c);}

    /* external overlay */
    .iframe-container{
      position:fixed;inset:0;display:grid;place-items:center;z-index:60;opacity:0;visibility:hidden;transition:all .24s ease;
      background:linear-gradient(180deg, rgba(2,6,23,0.7), rgba(2,6,23,0.9));
      backdrop-filter: blur(6px);
    }
    .iframe-container.active{opacity:1;visibility:visible;}
    .iframe-wrapper{width:94%;max-width:1200px;height:86vh;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;border:1px solid rgba(255,255,255,0.03);overflow:hidden;display:flex;flex-direction:column;}
    .iframe-toolbar{display:flex;align-items:center;gap:12px;padding:10px 12px;background:linear-gradient(90deg, rgba(255,255,255,0.02), transparent);border-bottom:1px solid rgba(255,255,255,0.02);}
    .iframe-title{font-weight:700;color:var(--accent3)}
    .iframe-content{flex:1}
    .iframe-content iframe{width:100%;height:100%;border:0}

    /* subtle animations */
    .fade-in{animation:fadeIn .4s ease both;}
    @keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
  </style>
</head>
<body>
  <div class="main-container">

    <!-- HEADER -->
    <header class="site-header">
      <div class="site-title">
        <div class="title-badge">SKYWORLD LOOTS</div>
        <div style="font-size:1.05rem;color:#cfe9ff;margin-left:6px;">Arcade Trip Assistant</div>
      </div>

      <div class="header-actions mt-2">
        <button id="show-sheet-btn" class="btn secondary text-xs">View Scoreboard</button>
        <button id="show-prize-btn" class="btn secondary text-xs">View Prize Pool</button>
        <button id="show-rules-btn" class="btn text-xs">Theme Park Rules</button>
        <button id="clear-chat-btn" class="btn text-xs" style="background:linear-gradient(90deg,#334155,#0f1724);">Clear Chat</button>
      </div>
    </header>

    <!-- CONTENT -->
    <main class="content-grid">

      <!-- SCHEDULE / INFO (LEFT) -->
      <section class="arcade-card fade-in">
        <div class="flex justify-between items-center mb-4">
          <div>
            <h3 class="text-xl font-bold" style="color:var(--accent1)">Day 1: Genting Theme Park & Dinner</h3>
            <p class="text-sm text-gray-400">11 to 12 December 2025 · Genting Highlands</p>
          </div>
          <div class="text-sm text-muted text-right" style="color:#93b3cc;font-size:0.9rem">First World Hotel · Checkout 11:00 AM</div>
        </div>

        <div class="timeline">
          <div class="schedule-item" data-expanded>
            <div class="schedule-time">07:30 AM</div>
            <div class="schedule-event">
              <div class="title">Gather at Office Loading Bay <span class="label-pill">IMPORTANT</span></div>
              <div class="schedule-details">Load luggage/backpacks into Ying's car. Put Secret Santa gifts into Mr Kelvin's car. Everyone must bring IC for check-in.</div>
            </div>
          </div>

          <div class="schedule-item">
            <div class="schedule-time">07:45 AM</div>
            <div class="schedule-event">
              <div class="title">Depart</div>
              <div class="schedule-details">Please be on time. If late, contact Selina or Jayce. Driver cannot wait — you may need to take your own transport (taxi/Grab).</div>
            </div>
          </div>

          <div class="schedule-item">
            <div class="schedule-time">09:15 AM</div>
            <div class="schedule-event">
              <div class="title">Gather at First World Lobby</div>
              <div class="schedule-details">Meet near the main escalator / information board. Prepare tickets & breakfast QR codes.</div>
            </div>
          </div>

          <div class="schedule-item">
            <div class="schedule-time">10:00 AM</div>
            <div class="schedule-event">
              <div class="title">Enter Theme Park & Locker (Andromeda Base)</div>
              <div class="schedule-details">Group photo at entrance, then rent lockers at Andromeda Base. Hosts will gather at lockers before lunch.</div>
            </div>
          </div>

          <div class="schedule-item">
            <div class="schedule-time">12:00 PM</div>
            <div class="schedule-event">
              <div class="title" style="color:#fb7185">Lunch & Mini Game (Animal Tag)</div>
              <div class="schedule-details">Gather at Andromeda locker → Buck Café for lunch (RM35 credit; extras paid by participant). Mini Game: Animal Tag begins.</div>
            </div>
          </div>

          <div class="schedule-item">
            <div class="schedule-time">4:00 PM</div>
            <div class="schedule-event">
              <div class="title">Central Park Rally (Pair Up Game)</div>
              <div class="schedule-details">Gather at Central Park Garden Gate. Collect lockers before assembling.</div>
            </div>
          </div>

          <div class="schedule-item">
            <div class="schedule-time">5:00 PM</div>
            <div class="schedule-event">
              <div class="title">Hotel Check-in (First World Hotel)</div>
              <div class="schedule-details">Hosts will assist with check-in. Helen, Kelly, and Ms Yeoh help with check-in process.</div>
            </div>
          </div>

          <div class="schedule-item">
            <div class="schedule-time">6:30 PM</div>
            <div class="schedule-event">
              <div class="title">Dinner at B&L (Seating & Boss Speech)</div>
              <div class="schedule-details">6:30 Seating & Speech · 7:00 Dinner · 8:00 Secret Santa · 8:45 Mini Game · 9:00 Lucky Draw</div>
            </div>
          </div>
        </div>
      </section>

      <!-- CHAT (RIGHT) -->
      <aside class="arcade-card chat-card fade-in">
        <div class="chat-header">
          <div class="bot-avatar">J</div>
          <div>
            <div style="font-weight:800;color:var(--accent2)">JAYCE BOT</div>
            <div style="font-size:0.85rem;color:#9fb0c8">Official Trip Assistant — 11–12 Dec</div>
          </div>
        </div>

        <div id="chat-messages" class="chat-area" aria-live="polite">
          <!-- Initial welcome -->
          <div class="msg-row bot">
            <div class="bot-avatar" aria-hidden="true">J</div>
            <div class="bubble bot">
              Hi! I’m <strong>Jayce Bot</strong>, your official Genting trip assistant for <strong>11–12 December</strong>.<br><br>
              I can help with schedule, meeting points, logistics, meals, mini games, and current status.<br><br>
              Example questions:<br>
              • Where should I gather now?<br>
              • What is the next event?<br>
              • When is lunch?<br>
              • What happens if I am late?<br><br>
              How can I help?
            </div>
          </div>
        </div>

        <div class="chat-input-area">
          <form id="chat-form" class="flex w-full items-center">
            <input id="user-input" class="chat-input" placeholder="Ask Jayce Bot (e.g., 'Where should I gather now?')"
              aria-label="Ask Jayce Bot" required autocomplete="off" />
            <button id="send-button" class="btn" type="submit" aria-label="Send message">Send</button>
          </form>
        </div>
      </aside>
    </main>

    <!-- EXTERNAL IFRAME OVERLAY -->
    <div id="external-view" class="iframe-container" role="dialog" aria-hidden="true">
      <div class="iframe-wrapper">
        <div class="iframe-toolbar">
          <button id="close-external" class="btn secondary" type="button">&larr; Back</button>
          <div class="iframe-title" id="iframe-title">External View</div>
        </div>
        <div class="iframe-content">
          <iframe id="external-iframe" src="" title="External Document"></iframe>
        </div>
      </div>
    </div>

  </div>

  <script>
    // --- Config (keep your Gemini + system instruction as before) ---
    const MODEL_NAME = "gemini-2.5-flash-preview-09-2025";
    const API_BASE_URL = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent`;
    const apiKey = "AIzaSyCo5B2_Azu1c66ivlAKfF712VwAQ_peTAE"; // kept per your environment

    const SCOREBOARD_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vShFGBBJoJcmTZjGvN4T6nWve1VocnyENukSihj5LnlZMm3PU5s4eKLmE3uW07YJG7Det1LErGrAPUz/pubhtml?gid=1037652140&single=true";
    const PRIZE_POOL_URL = "https://docs.google.com/document/d/e/2PACX-1vTNpUtpmWSAKCM-gAn4kGGkY8c3oLy8XDIDgdwQr_pKa0-jFEY1kxlodfIfpsaLog3aUdpMyYg02xtM/pub";
    const THEME_PARK_RULES_URL = "https://www.gentingskyworlds.com/en/rules-regulations.html";

    // --- System instruction (unchanged from your latest) ---
    const SYSTEM_INSTRUCTION_CONTENT = `
            You are Jayce Bot, the official assistant for the Company Trip to Genting SkyWorlds. 
            Your job is to guide participants ONLY for the dates 11 and 12 December, and ONLY for itinerary-related questions.
            
            Before the user asks anything, you are instructed to greet them, but that greeting is already handled in the UI.

            ----------------------------------------------------------------------
            GENERAL RULES
            ----------------------------------------------------------------------
            
            1. ONLY answer questions related to the trip on 11–12 December. 
               If the user asks about weather, Genting food recommendations, hotel facilities, toilets, rides, or anything outside the itinerary, reply with the following EXACT phrase: 
               “Please ask the host (Selina or Jayce) for this.”
            
            2. If the user asks for information NOT provided in the itinerary (e.g., number of game targets, locker price), 
               reply with the following EXACT phrase: 
               “Please ask the host (Selina or Jayce) for this.”
            
            3. After EVERY answer, you MUST add a “Status Update” section where you: 
               - Understand the user's stated current time and date 
               - Determine what they should be doing now based on the itinerary 
               - Identify the next event in the schedule 
            
               Format it exactly like this, using the time and date provided by the user:
            
               ---
               **Status Update** Current Time: <time>, <date> 
               You should currently be: <what they should be doing> 
               Next Event: <next event> 
               ---
            
            4. If the user does NOT mention the current time, and their question requires time context (e.g., "Where should I gather now?"), ask: 
               “Please tell me the current time so I can guide you accurately.”
            
            5. If the user is late for the morning gathering on 11 Dec (before 7:45 AM): 
               Respond with the specific latecomer response (see FIXED LOGISTICS).
            
            ----------------------------------------------------------------------
            FIXED LOGISTICS KNOWLEDGE (USE THESE EXACTLY)
            ----------------------------------------------------------------------
            
            • Latecomer Response (if late for morning gathering on 11 Dec): 
              “If you are late, please contact the host (Selina or Jayce). If you cannot arrive in time, you may need to take your own transport (taxi/Grab) to Genting as the driver cannot wait.”

            • Gathering Point (11 Dec Morning): Office Loading Bay.
            • Hotel: First World Hotel 
            • Checkout Time: 11:00 AM on 12 December 
            
            • Food & Meals:
              Participants gather at the locker area first. 
              Hosts will then bring everyone to the café together. 
              Participants may order food above RM35, but any extra amount must be paid by themselves.
            
            • Committee Roles: 
              - Selina: Almost everything 
              - Jayce: Almost everything 
              - Helen, Kelly, Ms Yeoh: Assist with hotel check-in 
            
            ----------------------------------------------------------------------
            WHAT PARTICIPANTS SHOULD BRING (DEFAULT GUIDELINES)
            ----------------------------------------------------------------------
            
            If asked, recommend only these general items:
            • Power bank 
            • Water bottle 
            • Jacket (Genting is cold)
            • Small bag 
            • Personal necessities 
            • Money 
            • Raincoat (say it may be needed if raining)
            
            Do NOT invent prohibited items. If user asks about an uncertain item, use the general "Please ask the host..." rule.
            
            ----------------------------------------------------------------------
            TRIP ITINERARY (IMPORTANT — FOLLOW STRICTLY)
            ----------------------------------------------------------------------
            
            **Dec 11 - Morning/Afternoon Schedule:**
            - 07:30 AM: Gather at office loading bay.
            - 07:45 AM: Depart.
            - 09:15 AM: Gather at First World Lobby.
            - 09:30 AM: Depart to SkyWorlds Theme Park.
            - 10:00 AM: Enter theme park, take a group photo, and rent lockers at Andromeda Base.
            - 10:30 AM - 12:00 PM: Free Time (Theme Park).
            - 12:00 PM: Gather at Andromeda Base locker area, have lunch at Buck Cafe, and start the Mini Game (Animal Tag).
            - 1:00 PM - 4:00 PM: Free Time (Theme Park).
            - 4:00 PM: Gather in Central Park for the Mini Game (Pair Up Game).
            - 4:30 PM: Exit theme park.
            - 5:00 PM: Hotel Check-in (First World Hotel).
            - 6:00 PM: Gather in the lobby and head to the Annual Dinner venue.
            
            **Dec 11 - Evening Plan (Annual Dinner at B&L):**
            - 6:30 PM: Seating & Boss speech
            - 7:00 PM: Dinner
            - 8:00 PM: Secret Santa Exchange
            - 8:45 PM: Mini Game
            - 9:00 PM: Lucky Draw
            - 9:30 PM: Bonus & Closing Speech
            - Optional: 10:30 PM Snow Show
            
            **Dec 12 - Departure Day Schedule:**
            - Until 11:00 AM: Free time, enjoy breakfast (QR code provided), pack.
            - 11:00 AM: Checkout Time.
            
            **Rain Plan B (Morning):** If raining, Photo Target game changes to Poker face + thumbs up in Skytropolis or Dramatic pose with dinosaur. Individual missions change to: Selfie in front of casino, Photo of throwing rubbish in a bin, Selfie with zombie. Gather at 11:30 AM at theme park entrance.
            **Rain Plan B (4:00 PM):** Formation War gathering changes to Theme Park Exit. Mini game moves to Ripley’s Adventureland or Skytropolis Indoor Theme Park.
            
            ----------------------------------------------------------------------
            END OF SYSTEM INSTRUCTION
            ----------------------------------------------------------------------
        `;

    // --- DOM refs ---
    const chatForm = document.getElementById('chat-form');
    const userInput = document.getElementById('user-input');
    const chatMessages = document.getElementById('chat-messages');
    const sendButton = document.getElementById('send-button');
    const showSheetBtn = document.getElementById('show-sheet-btn');
    const showPrizeBtn = document.getElementById('show-prize-btn');
    const showRulesBtn = document.getElementById('show-rules-btn');
    const externalView = document.getElementById('external-view');
    const externalIframe = document.getElementById('external-iframe');
    const iframeTitle = document.getElementById('iframe-title');
    const closeExternal = document.getElementById('close-external');
    const clearChatBtn = document.getElementById('clear-chat-btn');

    let chatHistory = [];

    // Utility: create message row
    function addMessageToChat(text, sender, opts = {}) {
      const row = document.createElement('div');
      row.className = 'msg-row ' + (sender === 'user' ? 'user' : 'bot');

      const avatar = document.createElement('div');
      avatar.className = sender === 'user' ? 'user-avatar' : 'bot-avatar';
      avatar.textContent = sender === 'user' ? 'U' : 'J';

      const bubble = document.createElement('div');
      bubble.className = 'bubble ' + (sender === 'user' ? 'user' : 'bot');
      bubble.innerHTML = text.replace(/\n/g, '<br>');

      if (opts.loading) {
        const typing = document.createElement('span');
        typing.className = 'typing';
        typing.innerHTML = '<span class="dot"></span><span class="dot"></span><span class="dot"></span>';
        bubble.innerHTML = '';
        bubble.appendChild(typing);
      }

      row.appendChild(avatar);
      row.appendChild(bubble);
      chatMessages.appendChild(row);
      chatMessages.scrollTop = chatMessages.scrollHeight;

      return {row, bubble, avatar};
    }

    // Exponential backoff fetch
    async function exponentialBackoffFetch(url, options, retries = 5, delay = 1000) {
      for (let i = 0; i < retries; i++) {
        try {
          const res = await fetch(url, options);
          if (res.ok) return res;
          if (res.status === 429 && i < retries - 1) {
            await new Promise(r => setTimeout(r, delay));
            delay *= 2;
          } else {
            throw new Error('API failed with status: ' + res.status);
          }
        } catch (err) {
          if (i === retries - 1) throw err;
          await new Promise(r => setTimeout(r, delay));
          delay *= 2;
        }
      }
    }

    // API call
    async function fetchGeminiResponse(userQuery) {
      const apiUrl = `${API_BASE_URL}?key=${apiKey}`;

      // store user msg
      chatHistory.push({ role: "user", parts: [{ text: userQuery }] });

      const payload = {
        contents: chatHistory,
        systemInstruction: { parts: [{ text: SYSTEM_INSTRUCTION_CONTENT }] }
      };

      const options = {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      };

      // show loading msg
      const loading = addMessageToChat('', 'bot', {loading:true});
      sendButton.disabled = true;

      try {
        const response = await exponentialBackoffFetch(apiUrl, options);
        const result = await response.json();
        const candidate = result.candidates?.[0];
        let botText = "Sorry, I couldn't process that. Please try again or contact a host.";

        if (candidate && candidate.content?.parts?.[0]?.text) {
          botText = candidate.content.parts[0].text;
          chatHistory.push({ role: "model", parts: [{ text: botText }] });
        }

        // replace loading bubble
        loading.bubble.innerHTML = botText.replace(/\n/g, '<br>');
        chatMessages.scrollTop = chatMessages.scrollHeight;

      } catch (err) {
        console.error('Gemini API Error:', err);
        loading.bubble.innerHTML = '⚠️ Network Error. The request to the API failed. Please contact a host if this persists.';
        chatHistory.pop(); // remove last user if failed
      } finally {
        sendButton.disabled = false;
      }
    }

    // handle form submit
    chatForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const query = userInput.value.trim();
      if (!query) return;
      addMessageToChat(query, 'user');
      fetchGeminiResponse(query);
      userInput.value = '';
      userInput.focus();
    });

    // schedule expand/collapse
    document.querySelectorAll('.schedule-item').forEach(item=>{
      item.addEventListener('click', ()=>{
        item.classList.toggle('expanded');
      });
    });

    // external view controls
    function showExternalView(url, title) {
      externalIframe.src = url;
      iframeTitle.textContent = title;
      externalView.classList.add('active');
      externalView.setAttribute('aria-hidden','false');
      document.body.style.overflow = 'hidden';
    }
    function hideExternalView() {
      externalView.classList.remove('active');
      externalView.setAttribute('aria-hidden','true');
      externalIframe.src = '';
      document.body.style.overflow = '';
    }

    showSheetBtn.addEventListener('click', ()=> showExternalView(SCOREBOARD_URL, 'Live Mini-Game Scoreboard'));
    showPrizeBtn.addEventListener('click', ()=> showExternalView(PRIZE_POOL_URL, 'Annual Dinner Prize Pool'));
    showRulesBtn.addEventListener('click', ()=> window.open(THEME_PARK_RULES_URL, '_blank'));
    closeExternal.addEventListener('click', hideExternalView);

    // clear chat
    clearChatBtn.addEventListener('click', ()=>{
      // keep the welcome message
      chatMessages.innerHTML = '';
      const welcome = `
        <div class="msg-row bot">
          <div class="bot-avatar">J</div>
          <div class="bubble bot">
            Hi! I’m <strong>Jayce Bot</strong>, your official Genting trip assistant for <strong>11–12 December</strong>.<br><br>
            I can help with schedule, meeting points, logistics, meals, mini games, and current status.<br><br>
            Example questions:<br>
            • Where should I gather now?<br>
            • What is the next event?<br>
            • When is lunch?<br>
            • What happens if I am late?<br><br>
            How can I help?
          </div>
        </div>
      `;
      chatMessages.insertAdjacentHTML('beforeend', welcome);
      chatMessages.scrollTop = chatMessages.scrollHeight;
      chatHistory = [];
    });

    // accessibility: allow send with Ctrl+Enter
    userInput.addEventListener('keydown', (e)=>{
      if (e.ctrlKey && e.key === 'Enter') {
        e.preventDefault();
        document.getElementById('send-button').click();
      }
    });

    // initial setup: ensure overlay hidden
    document.addEventListener('DOMContentLoaded', ()=>{
      hideExternalView();
    });
  </script>
</body>
</html>
