<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dominant Color Analyzer</title>
    <!-- Load Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom font and basic body style */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
            color: #1f2937;
        }
        /* Custom file input styling to look like a button */
        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            cursor: pointer;
        }
        .file-input-wrapper input[type=file] {
            font-size: 100px;
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            cursor: pointer;
        }
    </style>
</head>
<body class="min-h-screen p-4 flex items-center justify-center">

<div class="w-full max-w-lg bg-white p-6 md:p-8 rounded-xl shadow-2xl space-y-6">
    <h1 class="text-3xl font-bold text-center text-blue-600">
        Pixel Color Analyst (AI Powered)
    </h1>
    <p class="text-center text-gray-500">
        Upload a photo and the AI will analyze it to find the greatest number of pixels of one color, and provide the name and hex code.
    </p>

    <!-- Upload/Capture Button -->
    <div class="flex justify-center">
        <div class="file-input-wrapper">
            <button id="uploadButton" class="bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg transition duration-200 shadow-md">
                Upload or Take Photo
            </button>
            <!-- The 'capture=camera' attribute allows the iPhone to directly open the camera -->
            <input type="file" id="imageInput" accept="image/*" capture="camera" />
        </div>
    </div>

    <!-- Status and Loading Area -->
    <div id="statusMessage" class="text-center text-sm text-gray-700 h-6"></div>

    <!-- Image Preview Area -->
    <div id="previewContainer" class="hidden text-center">
        <h2 class="text-xl font-semibold mb-3 text-gray-700">Image Preview</h2>
        <img id="imagePreview" class="max-w-full h-auto mx-auto rounded-lg shadow-lg" src="" alt="Image Preview" style="max-height: 300px; object-fit: contain;">
    </div>

    <!-- Analysis Result Area -->
    <div id="resultContainer" class="hidden bg-gray-50 p-4 rounded-lg border border-gray-200">
        <h2 class="text-xl font-bold text-center mb-4 text-green-700">Analysis Complete!</h2>
        
        <div class="flex flex-col sm:flex-row items-center justify-center space-y-4 sm:space-y-0 sm:space-x-6">
            <!-- Color Swatch -->
            <div id="colorSwatch" class="w-24 h-24 rounded-full shadow-xl border-4 border-white transition-all duration-300" style="background-color: #ffffff;"></div>
            
            <!-- Details -->
            <div class="text-center sm:text-left">
                <p class="text-lg font-medium text-gray-600">Dominant Color:</p>
                <p id="colorName" class="text-3xl font-extrabold text-gray-800">---</p>
                <p class="text-lg font-medium text-gray-600 mt-2">Hex Code:</p>
                <p id="hexCode" class="text-2xl font-mono text-gray-800 bg-yellow-100 px-2 py-1 rounded-md inline-block">#FFFFFF</p>
                <button onclick="copyToClipboard('hexCode')" class="ml-2 text-sm text-blue-500 hover:text-blue-700 transition duration-150">
                    (Copy)
                </button>
            </div>
        </div>
        <p id="aiSummary" class="mt-4 text-sm text-gray-500 text-center italic"></p>
    </div>
</div>

<script type="module">
    // Global variables (set by the Canvas environment)
    const apiKey = "";
    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

    // DOM Elements
    const imageInput = document.getElementById('imageInput');
    const imagePreview = document.getElementById('imagePreview');
    const previewContainer = document.getElementById('previewContainer');
    const resultContainer = document.getElementById('resultContainer');
    const statusMessage = document.getElementById('statusMessage');
    const colorSwatch = document.getElementById('colorSwatch');
    const colorName = document.getElementById('colorName');
    const hexCode = document.getElementById('hexCode');
    const aiSummary = document.getElementById('aiSummary');
    const uploadButton = document.getElementById('uploadButton');

    // --- Utility Functions ---

    /** Converts a File/Blob object to a Base64 string for the API. */
    function fileToBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => {
                // The result is a data URL (e.g., "data:image/jpeg;base64,..."). 
                // We only need the base64 part after the comma.
                const base64String = reader.result.split(',')[1];
                resolve(base64String);
            };
            reader.onerror = error => reject(error);
            reader.readAsDataURL(file);
        });
    }

    /** Exponential backoff retry logic for API calls */
    async function fetchWithBackoff(url, options, retries = 5, delay = 1000) {
        for (let i = 0; i < retries; i++) {
            try {
                const response = await fetch(url, options);
                if (response.ok) {
                    return response;
                }
                if (response.status === 429 && i < retries - 1) { // Too Many Requests
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2; // Exponential increase
                    continue;
                }
                throw new Error(`API returned status ${response.status}`);
            } catch (error) {
                if (i === retries - 1) throw error;
                await new Promise(resolve => setTimeout(resolve, delay));
                delay *= 2;
            }
        }
    }

    /** Copies text to the clipboard using the older but safer execCommand method */
    window.copyToClipboard = function(elementId) {
        const copyText = document.getElementById(elementId);
        const range = document.createRange();
        range.selectNode(copyText);
        window.getSelection().removeAllRanges();
        window.getSelection().addRange(range);
        
        try {
            document.execCommand('copy');
            statusMessage.textContent = `Copied ${copyText.textContent} to clipboard!`;
            setTimeout(() => statusMessage.textContent = '', 2000);
        } catch (err) {
            statusMessage.textContent = 'Failed to copy text.';
        }
        window.getSelection().removeAllRanges(); // Deselect the text
    }


    // --- Core Logic ---

    imageInput.addEventListener('change', async function() {
        const file = this.files[0];
        if (!file) return;

        // Reset UI
        resultContainer.classList.add('hidden');
        colorSwatch.style.backgroundColor = '#ffffff';
        colorName.textContent = '---';
        hexCode.textContent = '#FFFFFF';
        aiSummary.textContent = '';
        statusMessage.textContent = '';
        uploadButton.disabled = true;

        // 1. Show Preview
        imagePreview.src = URL.createObjectURL(file);
        previewContainer.classList.remove('hidden');

        try {
            statusMessage.textContent = 'Processing image... (1/2)';
            const base64Data = await fileToBase64(file);
            
            statusMessage.textContent = 'Analyzing image with AI... (2/2)';

            // 2. Define the System Prompt and JSON Schema
            const systemPrompt = "You are a professional color analysis tool. Your task is to analyze the provided image, determine the single most frequently occurring, dominant color (the color occupying the greatest number of pixels), and output the result ONLY as a JSON object.";

            const userQuery = "Analyze the uploaded photo. Identify the single most dominant color (the color with the highest pixel count). Provide a descriptive name for the color and its corresponding hexadecimal code.";

            const payload = {
                contents: [
                    {
                        role: "user",
                        parts: [
                            { 
                                inlineData: {
                                    mimeType: file.type,
                                    data: base64Data
                                }
                            },
                            { text: userQuery }
                        ]
                    }
                ],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "dominantColorName": { 
                                "type": "STRING", 
                                "description": "A descriptive name for the color (e.g., 'Azure Blue', 'Deep Crimson')." 
                            },
                            "hexCode": { 
                                "type": "STRING", 
                                "description": "The 6-digit hexadecimal code for the color, including the leading '#' symbol (e.g., '#4B0082')." 
                            },
                            "summary": {
                                "type": "STRING",
                                "description": "A short, engaging sentence explaining why this color is dominant in the photo, mentioning the subject matter."
                            }
                        },
                        required: ["dominantColorName", "hexCode", "summary"]
                    }
                }
            };

            // 3. Call the API
            const response = await fetchWithBackoff(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const result = await response.json();

            // 4. Extract and Display Results
            const candidate = result.candidates?.[0];

            if (candidate && candidate.content?.parts?.[0]?.text) {
                const jsonText = candidate.content.parts[0].text.trim();
                const parsedJson = JSON.parse(jsonText);
                
                const dominantName = parsedJson.dominantColorName;
                const hex = parsedJson.hexCode;
                const summary = parsedJson.summary;

                colorSwatch.style.backgroundColor = hex;
                colorName.textContent = dominantName;
                hexCode.textContent = hex;
                aiSummary.textContent = summary;

                resultContainer.classList.remove('hidden');
                statusMessage.textContent = 'Success! Analysis displayed below.';

            } else {
                throw new Error("AI response was empty or malformed.");
            }


        } catch (error) {
            console.error("Analysis Error:", error);
            statusMessage.textContent = `Error during analysis. Please try a different photo. Details: ${error.message}`;
        } finally {
            uploadButton.disabled = false;
        }
    });
</script>

</body>
</html>