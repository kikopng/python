<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skyworld Loots - Arcade Theme</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom Neon Styling for Arcade Theme */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: 'Inter', sans-serif;
            background-color: #0f172a; /* Dark Slate Background */
        }
        .main-container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        .content-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
            padding: 1.5rem;
        }
        @media (min-width: 1024px) {
            .content-grid {
                grid-template-columns: 2fr 1fr; /* 2/3 for info, 1/3 for chat on desktop */
            }
        }
        
        /* Neon Glow Effect (Orange/Red for Title) */
        .neon-glow {
            color: #f97316; 
            text-shadow: 
                0 0 5px #f97316,
                0 0 10px #f97316,
                0 0 20px rgba(249, 115, 22, 0.7);
        }

        /* Card styles - Dark background with neon border/shadow */
        .arcade-card {
            background-color: #1e293b; /* Darker blue-slate */
            border-radius: 0.75rem;
            padding: 1.5rem;
            border: 2px solid #6366f1; /* Indigo/Purple border */
            box-shadow: 0 0 15px rgba(99, 102, 241, 0.5);
            color: #e2e8f0; /* Light text */
        }
        
        /* Chat card needs specific height for scrolling */
        .chat-card {
            display: flex;
            flex-direction: column;
            min-height: 50vh;
            max-height: 80vh; 
        }

        .chat-area {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1rem;
        }
        .chat-input-area {
            flex-shrink: 0;
            padding: 1rem;
            background-color: #111827; /* Near black input area */
            border-top: 1px solid #374151;
        }

        /* Full-screen iframe toggle styles */
        .iframe-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            z-index: 50; 
            background-color: #0f172a;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
            opacity: 0;
            visibility: hidden; 
        }
        .active-view {
            opacity: 1;
            visibility: visible;
        }
        .iframe-container iframe {
            width: 100%;
            height: 100%;
            border: none;
            padding-top: 50px;
        }

        /* Message Bubbles */
        .user-message {
            background-color: #ec4899; /* Neon Pink */
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 0;
            box-shadow: 0 0 5px #ec4899;
        }
        .bot-message {
            background-color: #ffffff; /* White background for bot message */
            color: #1f2937; /* Dark text */
            align-self: flex-start;
            border-bottom-left-radius: 0;
            border-radius: 0.75rem;
        }
        /* Neon Button Styling */
        .neon-button-primary {
            background-color: #3b82f6; /* Blue */
            color: white;
            box-shadow: 0 0 8px #3b82f6;
            transition: all 0.3s ease;
        }
        .neon-button-primary:hover {
            background-color: #60a5fa;
            box-shadow: 0 0 15px #60a5fa, 0 0 25px #60a5fa;
        }
        .neon-button-secondary {
             background-color: #ef4444; /* Red */
             color: white;
            box-shadow: 0 0 8px #ef4444;
            transition: all 0.3s ease;
        }
        .neon-button-secondary:hover {
             background-color: #f87171;
             box-shadow: 0 0 15px #f87171, 0 0 25px #f87171;
        }
        /* Schedule specific styles */
        .schedule-time {
            color: #10b981; /* Neon Green */
            font-weight: bold;
            text-shadow: 0 0 3px #10b981;
            width: 80px; /* Fixed width for alignment */
            flex-shrink: 0;
        }
        .schedule-event {
            border-left: 2px solid #a78bfa; /* Neon Purple line */
            padding-left: 1rem;
            color: #fcd34d; /* Neon Yellow/Gold for events */
        }
    </style>
</head>
<body>

    <!-- Main Content Interface (Trip Info + Chat) -->
    <div id="trip-details" class="main-container">
        
        <!-- Header -->
        <header class="flex flex-col items-center p-6 bg-gray-900 shadow-xl w-full z-10">
            <h1 class="text-5xl font-extrabold mb-4 neon-glow uppercase tracking-wider">Skyworld Loots</h1>
            
            <div class="flex flex-wrap justify-center gap-3">
                <button id="show-sheet-btn" class="neon-button-secondary font-bold py-2 px-4 rounded-full text-xs sm:text-sm focus:outline-none disabled:opacity-50">
                    View Scoreboard
                </button>
                <button id="show-prize-btn" class="neon-button-secondary font-bold py-2 px-4 rounded-full text-xs sm:text-sm focus:outline-none disabled:opacity-50">
                    View Prize Pool
                </button>
                <button id="show-rules-btn" class="neon-button-secondary font-bold py-2 px-4 rounded-full text-xs sm:text-sm focus:outline-none disabled:opacity-50">
                    Theme Park Rules
                </button>
            </div>
        </header>

        <!-- Content Grid: Schedule (Left) and Chatbot (Right) -->
        <div class="content-grid flex-grow">
            
            <!-- 1. Annual Dinner / Trip Information Card (Schedule) -->
            <div class="info-card arcade-card">
                <div class="flex justify-between items-center mb-6 border-b-2 border-indigo-400 pb-2">
                    <h2 class="text-2xl font-bold text-indigo-400">Day 1: Genting Theme Park & Dinner Schedule</h2>
                    <div class="text-sm font-light text-gray-400 text-right">
                        11 to 12 December 2025<br>
                        Genting Highland
                    </div>
                </div>
                
                <div class="space-y-4">
                    <!-- Schedule Item -->
                    <div class="flex items-start">
                        <span class="schedule-time">10:00 AM</span>
                        <div class="schedule-event">
                            <p class="font-semibold">Enter Theme Park & Prep</p>
                            <p class="text-sm text-gray-400">- Group Photo, Rent locker at Andromeda Base</p>
                        </div>
                    </div>

                    <!-- Schedule Item -->
                    <div class="flex items-start">
                        <span class="schedule-time">10:30 AM</span>
                        <div class="schedule-event">
                            <p class="font-semibold text-pink-400">FREE TIME</p>
                        </div>
                    </div>

                    <!-- Schedule Item -->
                    <div class="flex items-start">
                        <span class="schedule-time">12:00 PM</span>
                        <div class="schedule-event">
                            <p class="font-semibold">Lunch & Game Start</p>
                            <p class="text-sm text-gray-400">- Gather at Andromeda locker, Lunch at Buck Cafe</p>
                            <p class="text-sm text-red-400 font-bold">- Mini Game: Animal Tag</p>
                        </div>
                    </div>
                    
                     <!-- Schedule Item -->
                    <div class="flex items-start">
                        <span class="schedule-time">1:00 PM</span>
                        <div class="schedule-event">
                            <p class="font-semibold text-pink-400">FREE TIME</p>
                        </div>
                    </div>

                    <!-- Schedule Item -->
                    <div class="flex items-start">
                        <span class="schedule-time">4:00 PM</span>
                        <div class="schedule-event">
                            <p class="font-semibold">Central Park Rally</p>
                            <p class="text-sm text-gray-400">- Gather in Central Park</p>
                            <p class="text-sm text-red-400 font-bold">- Mini Game: Pair Up Game</p>
                        </div>
                    </div>

                    <!-- Schedule Item -->
                    <div class="flex items-start">
                        <span class="schedule-time">4:30 PM</span>
                        <div class="schedule-event">
                            <p class="font-semibold">Exit Theme Park</p>
                        </div>
                    </div>

                    <!-- Schedule Item -->
                    <div class="flex items-start">
                        <span class="schedule-time">5:00 PM</span>
                        <div class="schedule-event">
                            <p class="font-semibold">Hotel Check-in</p>
                        </div>
                    </div>

                    <!-- Schedule Item -->
                    <div class="flex items-start">
                        <span class="schedule-time">6:00 PM</span>
                        <div class="schedule-event">
                            <p class="font-semibold">Gather for Dinner</p>
                            <p class="text-sm text-gray-400">- Gather in lobby and head to B&L</p>
                        </div>
                    </div>
                    
                </div>
            </div>

            <!-- 2. Jayce Bot Chat Card (Small Section) -->
            <div class="chat-card arcade-card">
                <h2 class="text-xl font-bold p-4 border-b border-gray-700 flex-shrink-0">
                    <span class="text-cyan-400">JAYCE BOT</span> <span class="text-sm font-normal text-gray-400">- Official Trip Assistant</span>
                </h2>

                <!-- Chat Display Area -->
                <div id="chat-messages" class="chat-area flex flex-col space-y-4">
                    <!-- Initial Welcome Message (Updated to new requirements) -->
                    <div class="flex justify-start">
                        <div class="bot-message p-3 rounded-xl max-w-full shadow-sm text-sm">
                            Hi! I’m Jayce Bot, your official Genting trip assistant for <b>11–12 December</b>. <br>
                            I can help with anything about the schedule, meeting points, logistics, meals, mini games, and what you should be doing at any time. <br><br>
                            Example questions you can ask: <br>
                            • Where should I gather now? <br>
                            • What is the next event? <br>
                            • When is lunch? <br>
                            • What happens if I am late? <br>
                            • Where do we meet before going to the café? <br>
                            How can I help?
                        </div>
                    </div>
                    <!-- Chat messages will be appended here -->
                </div>

                <!-- Chat Input Area -->
                <div class="chat-input-area">
                    <form id="chat-form" class="flex space-x-3">
                        <input
                            type="text"
                            id="user-input"
                            placeholder="Ask Jayce Bot a question..."
                            required
                            class="flex-grow p-3 border border-gray-700 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 transition duration-150 bg-gray-800 text-white"
                        >
                        <button
                            type="submit"
                            id="send-button"
                            class="p-3 rounded-lg neon-button-primary disabled:opacity-50"
                        >
                            Send
                        </button>
                    </form>
                </div>
            </div>

        </div>
    </div>

    <!-- External Content View (Scoreboard/Prize Pool) -->
    <div id="external-view" class="iframe-container">
        <div class="fixed top-0 left-0 w-full bg-gray-900 shadow-lg p-2 z-20 flex items-center">
             <button onclick="showChatInterface()" class="neon-button-secondary font-bold py-2 px-4 rounded-lg text-sm transition duration-150">
                &larr; Back to Main Info
            </button>
            <span id="iframe-title" class="ml-4 text-lg font-semibold text-pink-400 neon-glow"></span>
        </div>
        <!-- Iframe to display the Google Sheet or Prize Pool Document -->
        <iframe
            id="external-iframe"
            src=""
            allowfullscreen="true"
            title="External Document View"
        ></iframe>
    </div>

    <script>
        // --- Core Gemini API Configuration ---
        const MODEL_NAME = "gemini-2.5-flash-preview-09-2025";
        const API_BASE_URL = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent`;
        
        // API key definition (must remain here for Canvas environment)
        const apiKey = "AIzaSyCo5B2_Azu1c66ivlAKfF712VwAQ_peTAE"; 

        // URLs for external content
        const SCOREBOARD_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vShFGBBJoJcmTZjGvN4T6nWve1VocnyENukSihj5LnlZMm3PU5s4eKLmE3uW07YJG7Det1LErGrAPUz/pubhtml?gid=1037652140&single=true";
        const PRIZE_POOL_URL = "https://docs.google.com/document/d/e/2PACX-1vTNpUtpmWSAKCM-gAn4kGGkY8c3oLy8XDIDgdwQr_pKa0-jFEY1kxlodfIfpsaLog3aUdpMyYg02xtM/pub";
        const THEME_PARK_RULES_URL = "https://www.gentingskyworlds.com/en/rules-regulations.html";

        // ----------------------------------------------------------------------
        // JAYCE BOT SYSTEM INSTRUCTION (MANDATORY RULES & KNOWLEDGE)
        // ----------------------------------------------------------------------
        const SYSTEM_INSTRUCTION_CONTENT = `
            You are Jayce Bot, the official assistant for the Company Trip to Genting SkyWorlds. 
            Your job is to guide participants ONLY for the dates 11 and 12 December, and ONLY for itinerary-related questions.
            
            Before the user asks anything, you are instructed to greet them, but that greeting is already handled in the UI.

            ----------------------------------------------------------------------
            GENERAL RULES
            ----------------------------------------------------------------------
            
            1. ONLY answer questions related to the trip on 11–12 December. 
               If the user asks about weather, Genting food recommendations, hotel facilities, toilets, rides, or anything outside the itinerary, reply with the following EXACT phrase: 
               “Please ask the host (Selina or Jayce) for this.”
            
            2. If the user asks for information NOT provided in the itinerary (e.g., number of game targets, locker price), 
               reply with the following EXACT phrase: 
               “Please ask the host (Selina or Jayce) for this.”
            
            3. After EVERY answer, you MUST add a “Status Update” section where you: 
               - Understand the user's stated current time and date 
               - Determine what they should be doing now based on the itinerary 
               - Identify the next event in the schedule 
            
               Format it exactly like this, using the time and date provided by the user:
            
               ---
               **Status Update** Current Time: <time>, <date> 
               You should currently be: <what they should be doing> 
               Next Event: <next event> 
               ---
            
            4. If the user does NOT mention the current time, and their question requires time context (e.g., "Where should I gather now?"), ask: 
               “Please tell me the current time so I can guide you accurately.”
            
            5. If the user is late for the morning gathering on 11 Dec (before 7:45 AM): 
               Respond with the specific latecomer response (see FIXED LOGISTICS).
            
            ----------------------------------------------------------------------
            FIXED LOGISTICS KNOWLEDGE (USE THESE EXACTLY)
            ----------------------------------------------------------------------
            
            • Latecomer Response (if late for morning gathering on 11 Dec): 
              “If you are late, please contact the host (Selina or Jayce). If you cannot arrive in time, you may need to take your own transport (taxi/Grab) to Genting as the driver cannot wait.”

            • Gathering Point (11 Dec Morning): Office Loading Bay.
            • Hotel: First World Hotel 
            • Checkout Time: 11:00 AM on 12 December 
            
            • Food & Meals:
              Participants gather at the locker area first. 
              Hosts will then bring everyone to the café together. 
              Participants may order food above RM35, but any extra amount must be paid by themselves.
            
            • Committee Roles: 
              - Selina: Almost everything 
              - Jayce: Almost everything 
              - Helen, Kelly, Ms Yeoh: Assist with hotel check-in 
            
            ----------------------------------------------------------------------
            WHAT PARTICIPANTS SHOULD BRING (DEFAULT GUIDELINES)
            ----------------------------------------------------------------------
            
            If asked, recommend only these general items:
            • Power bank 
            • Water bottle 
            • Jacket (Genting is cold)
            • Small bag 
            • Personal necessities 
            • Money 
            • Raincoat (say it may be needed if raining)
            
            Do NOT invent prohibited items. If user asks about an uncertain item, use the general "Please ask the host..." rule.
            
            ----------------------------------------------------------------------
            TRIP ITINERARY (IMPORTANT — FOLLOW STRICTLY)
            ----------------------------------------------------------------------
            
            **Dec 11 - Morning/Afternoon Schedule:**
            - 07:30 AM: Gather at office loading bay.
            - 07:45 AM: Depart.
            - 09:15 AM: Gather at First World Lobby.
            - 09:30 AM: Depart to SkyWorlds Theme Park.
            - 10:00 AM: Enter theme park, take a group photo, and rent lockers at Andromeda Base.
            - 10:30 AM - 12:00 PM: Free Time (Theme Park).
            - 12:00 PM: Gather at Andromeda Base locker area, have lunch at Buck Cafe, and start the Mini Game (Animal Tag).
            - 1:00 PM - 4:00 PM: Free Time (Theme Park).
            - 4:00 PM: Gather in Central Park for the Mini Game (Pair Up Game).
            - 4:30 PM: Exit theme park.
            - 5:00 PM: Hotel Check-in (First World Hotel).
            - 6:00 PM: Gather in the lobby and head to the Annual Dinner venue.
            
            **Dec 11 - Evening Plan (Annual Dinner at B&L):**
            - 6:30 PM: Seating & Boss speech
            - 7:00 PM: Dinner
            - 8:00 PM: Secret Santa Exchange
            - 8:45 PM: Mini Game
            - 9:00 PM: Lucky Draw
            - 9:30 PM: Bonus & Closing Speech
            - Optional: 10:30 PM Snow Show
            
            **Dec 12 - Departure Day Schedule:**
            - Until 11:00 AM: Free time, enjoy breakfast (QR code provided), pack.
            - 11:00 AM: Checkout Time.
            
            **Rain Plan B (Morning):** If raining, Photo Target game changes to Poker face + thumbs up in Skytropolis or Dramatic pose with dinosaur. Individual missions change to: Selfie in front of casino, Photo of throwing rubbish in a bin, Selfie with zombie. Gather at 11:30 AM at theme park entrance.
            **Rain Plan B (4:00 PM):** Formation War gathering changes to Theme Park Exit. Mini game moves to Ripley’s Adventureland or Skytropolis Indoor Theme Park.
            
            ----------------------------------------------------------------------
            END OF SYSTEM INSTRUCTION
            ----------------------------------------------------------------------
        `;

        // --- DOM Elements and State ---
        const tripDetails = document.getElementById('trip-details');
        const externalView = document.getElementById('external-view');
        const externalIframe = document.getElementById('external-iframe');
        const iframeTitle = document.getElementById('iframe-title');
        
        const showSheetBtn = document.getElementById('show-sheet-btn');
        const showPrizeBtn = document.getElementById('show-prize-btn');
        const showRulesBtn = document.getElementById('show-rules-btn');

        const chatForm = document.getElementById('chat-form');
        const userInput = document.getElementById('user-input');
        const chatMessages = document.getElementById('chat-messages');
        const sendButton = document.getElementById('send-button');

        let chatHistory = [];

        // --- Chat UI Functions ---
        function addMessageToChat(text, sender) {
            const isUser = sender === 'user';
            const messageId = crypto.randomUUID();

            const messageHtml = `
                <div id="msg-${messageId}" class="flex ${isUser ? 'justify-end' : 'justify-start'}">
                    <div class="p-3 rounded-xl whitespace-pre-wrap max-w-xs sm:max-w-md shadow-sm text-sm ${isUser ? 'user-message' : 'bot-message'}">
                        ${sender === 'loading' ? '<div class="flex items-center space-x-2"><svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-pink-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span class="text-gray-400">Typing...</span></div>' : text.replace(/\n/g, '<br>')}
                    </div>
                </div>
            `;
            chatMessages.insertAdjacentHTML('beforeend', messageHtml);
            
            chatMessages.scrollTop = chatMessages.scrollHeight;

            return messageId;
        }
        
        // --- Gemini API Call Logic ---
        async function exponentialBackoffFetch(url, options, retries = 5, delay = 1000) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.ok) {
                        return response;
                    }
                    if (response.status === 429 && i < retries - 1) {
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2; 
                    } else {
                        throw new Error(`API failed with status: ${response.status}`);
                    }
                } catch (error) {
                    if (i === retries - 1) throw error;
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2;
                }
            }
        }

        async function fetchGeminiResponse(userQuery) {
            const apiUrl = `${API_BASE_URL}?key=${apiKey}`;

            chatHistory.push({ role: "user", parts: [{ text: userQuery }] });

            const payload = {
                contents: chatHistory,
                systemInstruction: {
                    parts: [{ text: SYSTEM_INSTRUCTION_CONTENT }]
                },
            };

            const options = {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            };

            let loadingId = addMessageToChat('', 'loading');
            sendButton.disabled = true;

            try {
                const response = await exponentialBackoffFetch(apiUrl, options);
                const result = await response.json();
                
                const candidate = result.candidates?.[0];
                let botText = "Sorry, I couldn't process that. Please try again or contact a host.";

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    botText = candidate.content.parts[0].text;
                    chatHistory.push({ role: "model", parts: [{ text: botText }] });
                }

                const loadingElement = document.getElementById(`msg-${loadingId}`);
                if (loadingElement) {
                    // Note: botText contains formatting like \n and ---, which we allow the browser to interpret as line breaks using the whitespace-pre-wrap style.
                    loadingElement.outerHTML = `
                        <div class="flex justify-start">
                            <div class="bot-message p-3 rounded-xl max-w-xs sm:max-w-md shadow-sm text-sm">
                                ${botText}
                            </div>
                        </div>
                    `;
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }

            } catch (error) {
                console.error("Gemini API Error:", error);
                const loadingElement = document.getElementById(`msg-${loadingId}`);
                if (loadingElement) {
                    loadingElement.outerHTML = `
                        <div class="flex justify-start">
                            <div class="bot-message p-3 rounded-xl max-w-xs sm:max-w-md shadow-sm text-sm text-red-500 bg-red-900/50 border border-red-500">
                                ⚠️ Network Error. The request to the API failed. This is likely due to an issue with the API Key or network firewall.
                            </div>
                        </div>
                    `;
                }
                chatHistory.pop(); 
            } finally {
                sendButton.disabled = false;
            }
        }


        // --- External View Toggling ---

        function showExternalView(url, title) {
            externalIframe.src = url;
            iframeTitle.textContent = title;
            tripDetails.style.display = 'none'; 
            externalView.classList.add('active-view');
        }

        function showScoreboard() {
            showExternalView(SCOREBOARD_URL, 'Live Mini-Game Scoreboard');
        }

        function showPrizePool() {
            showExternalView(PRIZE_POOL_URL, 'Annual Dinner Prize Pool');
        }
        
        function openRulesAndRegulations() {
            window.open(THEME_PARK_RULES_URL, '_blank');
        }

        function showChatInterface() {
            externalView.classList.remove('active-view');
            tripDetails.style.display = 'flex'; 
            externalIframe.src = ""; 
        }

        // Handle chat form submission
        chatForm.addEventListener('submit', function(event) {
            event.preventDefault();
            const query = userInput.value.trim();
            if (query) {
                // The new system prompt handles the required greeting; we just send the user query.
                addMessageToChat(query, 'user');
                fetchGeminiResponse(query);
                userInput.value = '';
                userInput.focus();
            }
        });

        // Attach event listeners to all buttons
        showSheetBtn.addEventListener('click', showScoreboard);
        showPrizeBtn.addEventListener('click', showPrizePool);
        showRulesBtn.addEventListener('click', openRulesAndRegulations);


        // Initial setup
        document.addEventListener('DOMContentLoaded', () => {
            showChatInterface();
            externalView.classList.remove('active-view');
        });

    </script>

</body>
</html>
